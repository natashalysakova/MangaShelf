@page "/volume/{Id:guid}"
@using MangaShelf.Components.Elements.VolumeDetails
@using MangaShelf.DAL.Models
@using System.Security.Claims

@if (Volume != null)
{
    <MudGrid Spacing="6">
        <MudItem xs="12">

            <MudText Typo="Typo.h4">@Volume.Series.Title @Volume.Title</MudText>
            <MudText Typo="Typo.caption">@Volume.Series.OriginalName</MudText>
            <MudText Typo="Typo.h4"></MudText>
        </MudItem>
        <MudItem xs="12">
            <MudStack Row Breakpoint="Breakpoint.Xs">
                <MudItem xs="12" sm="4">
                    <MudItem>

                        <FallbackImage Class="img-fluid" ImageUrl="@Volume.CoverImageUrl"></FallbackImage>
                    </MudItem>
                    <MudItem>
                        <MudStack Row Justify="Justify.Center" Class="m-3">
                            <AuthorizeView>
                                <Authorized>
                                    <MudToggleIconButton @bind-Toggled="@IsLiked" Icon="@CustomIcons.notFiledHeart" Size="Size.Large"
                                                            Color="@Color.Default" ToggledIcon="@CustomIcons.filledHeart" ToggledColor="@Color.Error" />
                                    <MudIconButton Href="@Volume.PurchaseUrl" Target="_blank" Size="Size.Large" Icon="@Icons.Material.Rounded.ShoppingCart"></MudIconButton>
                                    <MudIconButton Icon="@Icons.Material.Rounded.PlaylistAdd" Size="Size.Large"></MudIconButton>
                                </Authorized>
                            </AuthorizeView>
                        </MudStack>

                        <MudStack Row Justify="Justify.Center" AlignItems="AlignItems.Center">
                            <RatingComponent RatingValue="@Volume.AvgRating"></RatingComponent>
                        </MudStack>

                    </MudItem>

                </MudItem>

                <MudItem xs="12" sm="8">
                    <MudStack>
                        @if (Volume.IsPreorder)
                        {
                            <MudAlert Severity="Severity.Warning" Elevation="0">
                                This volume is available for preorder until @Volume.ReleaseDate?.ToString("dd.MM.yyyy")
                            </MudAlert>
                        }
                        <MudTextField Variant="Variant.Filled" Label="@Localizer["Author"]" ReadOnly="true" ShrinkLabel="true"
                                        Value="@string.Join(", ", @Volume.Series.Authors)"></MudTextField>

                        <MudStack Row Breakpoint="Breakpoint.SmAndDown">
                            <MudTextField Variant="Variant.Filled" Label="@Localizer["Publisher"]" ReadOnly="true"
                                            Value="@Volume.Series.Publisher.Name"></MudTextField>
                            <MudStack Row>

                                <MudTextField Variant="Variant.Filled" Label="@Localizer["ISBN"]" ReadOnly="true"
                                                Value="@Volume.ISBN"></MudTextField>
                                <MudTextField Variant="Variant.Filled" Label="@Localizer["Age"]" ReadOnly="true"
                                                Value="@Volume.AgeRestriction"></MudTextField>
                            </MudStack>

                        </MudStack>

                        <MudStack Row Breakpoint="Breakpoint.SmAndDown">
                            <MudTextField Variant="Variant.Filled" Label="@Localizer["Status"]" ReadOnly="true"
                                            Value="@Localizer[Volume.Series.Status]"></MudTextField>
                            <MudStack Row>
                                <MudTextField Variant="Variant.Filled" Label="@Localizer["VolumeNumber"]" ReadOnly="true"
                                                Value="@Volume.Number"></MudTextField>
                                <MudTextField Variant="Variant.Filled" Label="@Localizer["TotalVolumes"]" ReadOnly="true"
                                                Value="@Volume.Series.TotalVolumes"></MudTextField>
                            </MudStack>
                        </MudStack>
                        <MudStack Row>

                            <MudTextField ShrinkLabel="true" Variant="Variant.Filled" Label="@Localizer["PreorderStarted"]"
                                            ReadOnly="true" Value="@Volume.PreorderStart?.ToString("dd.MM.yyyy")">
                            </MudTextField>
                            <MudTextField Variant="Variant.Filled" Label="@Localizer["Released"]" ReadOnly="true"
                                            Value="@Volume.ReleaseDate?.ToString("dd.MM.yyyy")"></MudTextField>
                        </MudStack>

                        <MudStack Row Breakpoint="Breakpoint.Xs" Justify="Justify.Center">
                            <MudStack Row>
                                <MudItem xs="6">

                                    <MudTextField Variant="Variant.Outlined"
                                                    Label="@Localizer["Wishlisted"]" ReadOnly="true"
                                                    Adornment="Adornment.Start"
                                                    AdornmentIcon="@CustomIcons.filledHeart"
                                                    Value="@Volume.Stats.WishlistsCount"></MudTextField>
                                </MudItem>
                                <MudItem xs="6">

                                    <MudTextField Variant="Variant.Outlined"
                                                    Label="@Localizer["InLibrary"]" ReadOnly="true"
                                                    Adornment="Adornment.Start"
                                                    AdornmentIcon="@Icons.Material.Filled.LibraryBooks"
                                                    Value="@Volume.Stats.OwnersCount"></MudTextField>
                                </MudItem>
                            </MudStack>
                            <MudStack Row>
                                <MudItem xs="6">

                                    <MudTextField Variant="Variant.Outlined"
                                                    Label="@Localizer["Reading"]" ReadOnly="true"
                                                    Adornment="Adornment.Start"
                                                    AdornmentIcon="@Icons.Material.Filled.RemoveRedEye"
                                                    Value="@Volume.Stats.ReadersCount"></MudTextField>
                                </MudItem>
                                <MudItem xs="6">

                                    <MudTextField Variant="Variant.Outlined"
                                                    Label="@Localizer["Finished"]" ReadOnly="true"
                                                    Adornment="Adornment.Start"
                                                    AdornmentIcon="@Icons.Material.Filled.Done"
                                                    Value="@Volume.Stats.CompletedCount"></MudTextField>
                                </MudItem>
                            </MudStack>

                        </MudStack>
                        <MudItem>
                            <MudText>@((MarkupString)Volume.Description)</MudText>
                        </MudItem>
                    </MudStack>
                </MudItem>
            </MudStack>
        </MudItem>
        <MudItem xs="12">
            <MudStack Row Breakpoint="Breakpoint.SmAndDown">
                <MudItem xs="12">
                    <Reviews VolumeId="@Volume.Id" />
                </MudItem>
                <MudItem xs="8">
                    <MoreInSeries Volume="@Volume"/>
                </MudItem>
            </MudStack>
        </MudItem>
        <MudItem>
            <MudSpacer></MudSpacer>
        </MudItem>
    </MudGrid>
}
else
{
    <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
}

@code {
    [Parameter()]
    public required Guid Id { get; set; }

    [Inject]
    public required IVolumeService VolumeService { get; set; }
    [Inject]
    public required IUiLocalizationService Localizer { get; set; }

    [CascadingParameter]
    public required Task<AuthenticationState> AuthStateTask { get; set; }

    private VolumeDto? Volume { get; set; }

    private UserVolumeStatus? VolumeStatus { get; set; }
    private bool IsLiked
    {
        get { return VolumeStatus?.LikeStatus == LikeStatus.Liked; }
        set
        {
            if (VolumeStatus != null)
            {

            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadVolumeInfo();

        await LoadVolumeUserStatus();
    }

    private async Task LoadVolumeInfo()
    {
        try
        {
            Volume = await VolumeService.GetFullVolumeByIdAsync(Id);
        }
        catch (Exception)
        {
        }
    }


    private async Task LoadVolumeUserStatus()
    {
        try
        {
            var authState = await AuthStateTask;
            var user = authState.User;
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId == null)
            {
                return;
            }
            VolumeStatus = await VolumeService.GetVolumeUserStatusAsync(Id, userId);
        }
        catch
        {
        }
    }

}
