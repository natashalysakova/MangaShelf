@using MangaShelf.Components.Pages.Admin.Elements
@using MangaShelf.Components.Pages.VolumePage.Elements
@using MangaShelf.DAL.Models
@using System.Security.Claims
@using System.Threading.Tasks
@using MangaShelf.Services

@inherits VolumeActionBase

@inject NavigationManager NavigationManager
@if (Volume != null)
{

    <MudPaper Outlined="true" Class="p-3 mb-3 paper-manga-panel">
        <MudStack Row>
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="4">
                <MudText Typo="Typo.h5">@Localizer["OwnershipData"]</MudText>
                <AuthorizeView>
                    <Authorized>
                        @if (VolumeState != null && VolumeState.CurrentUserStatus != null)
                        {
                            <MudStack Row>
                                <MudTextField Variant="Variant.Filled"
                                              Label="@Localizer["Status"]" ReadOnly="true"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.RemoveRedEye"
                                              Value="@Localizer[VolumeState.CurrentUserStatus.CurrentOwnershipStatus]"></MudTextField>
                                @if (VolumeState.CurrentUserStatus.Ownerships.Any(x => x.Status != VolumeStatus.None))
                                {
                                    <MudIconButton Variant="Variant.Text" OnClick="@(() => { _showTimeline = !_showTimeline; })" Color="@Color.Default" Icon="@Icons.Material.Filled.History"></MudIconButton>
                                }
                            </MudStack>

                            @if (VolumeState.CurrentUserStatus.CurrentOwnershipStatus == VolumeStatus.Preorder)
                            {
                                <MudButton Variant="Variant.Filled" OnClick="@(() => OpenSetOwnershipDialog(VolumeStatus.Own))" Color="@Color.Primary">@Localizer["ConfirmDelivery"]</MudButton>
                            }

                            @if (_showTimeline)
                            {
                                <OwnershipTimeline VolumeId="@VolumeId" />
                            }
                        }
                    </Authorized>
                    <NotAuthorized>
                        <MudText>@Localizer["LoginToSeeData"]</MudText>
                        <MudButton OnClick="OpenLoginPage">@Localizer["Login"]</MudButton>
                        <MudButton OnClick="OpenRegisterPage">@Localizer["Register"]</MudButton>
                    </NotAuthorized>
                </AuthorizeView>
            </MudStack>
        </MudStack>
    </MudPaper>
}

@code {
    [Parameter]
    public VolumeDto? Volume { get; set; }

    protected override Guid? ResolvedVolumeId { get => Volume?.Id; }

    private bool _showTimeline = false;


    private void OpenLoginPage(MouseEventArgs args)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        var currentUrl = string.IsNullOrEmpty(relativePath) ? "/" : "/" + relativePath;
        string loginUrl = $"/login?returnUrl={Uri.EscapeDataString(currentUrl)}";
        NavigationManager.NavigateTo(loginUrl);
    }

    private void OpenRegisterPage(MouseEventArgs args)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        var currentUrl = string.IsNullOrEmpty(relativePath) ? "/" : "/" + relativePath;
        string loginUrl = $"/register?returnUrl={Uri.EscapeDataString(currentUrl)}";
        NavigationManager.NavigateTo(loginUrl);
    }
}