@using MangaShelf.DAL.Models
@using System.Security.Claims
@using System.Threading.Tasks

@inject IVolumePageLocalizationService Localizer
@inject IVolumeService VolumeService
@inject IVolumeStateService VolumeState
@inject ILogger<UserActionsComponent> Logger
@inject ISnackbar Snackbar

@if (VolumeState.CurrentUserStatus != null)
{
    <AuthorizeView>
        <Authorized>
            <MudStack Row Justify="Justify.Center">
                <MudTooltip Arrow="true" Delay="250" Duration="250" Placement="Placement.Top" Text="@Localizer["Like"]">

                    <MudToggleIconButton @bind-Toggled="@VolumeState.CurrentUserStatus.IsLiked"
                                         Size="Size.Large"
                                         @onclick="ToggleLike"
                                         Icon="@CustomIcons.notFiledHeart" Color="@Color.Default"
                                         ToggledIcon="@CustomIcons.filledHeart" ToggledColor="@Color.Error" />
                </MudTooltip>
                <MudTooltip Arrow="true" Delay="250" Duration="250" Placement="Placement.Top" Text="@Localizer["GoToWebsite"]">
                    <MudIconButton Href="@Volume.PurchaseUrl" Target="_blank" Size="Size.Large" Icon="@Icons.Material.Rounded.ShoppingCart"></MudIconButton>
                </MudTooltip>

                <MudTooltip Arrow="true" Delay="250" Duration="250" Placement="Placement.Top" Text="@Localizer["LibraryMenu"]">
                    <MudMenu Icon="@CustomIcons.bookshelf" Size="Size.Large"
                             Color="Color.Warning"
                             AriaLabel="Open user menu">

                        @foreach (var action in availableActions)
                        {
                            <MudMenuItem Icon="@action.Icon" IconColor="@action.Color" Label="@Localizer[action.Lable]" @onclick="@action.Handler" />
                        }
                    </MudMenu>
                </MudTooltip>
                <MudTooltip Arrow="true" Delay="250" Duration="250" Placement="Placement.Top" Text="@Localizer["ReadingMenu"]">
                    <MudIconButton OnClick="()=>ShowAddEditReadingDialog(null)" Size="Size.Large" Color="@Color.Success" Icon="@CustomIcons.reading"></MudIconButton>
                </MudTooltip>

            </MudStack>
        </Authorized>
    </AuthorizeView>
}


@code {
    [Parameter, EditorRequired]
    public VolumeDto Volume { get; set; }

    protected override void OnInitialized()
    {
        VolumeState.OnUserStatusChanged += HandleUserStatusChanged;
        BuildListAvailableActions();
    }

    private void HandleUserStatusChanged()
    {
        BuildListAvailableActions();
        StateHasChanged();
    }

    private record AvailableAction(string Lable, string Icon, Color Color, Func<Task> Handler);
    private List<AvailableAction> availableActions;

    private void BuildListAvailableActions()
    {
        availableActions = new List<AvailableAction>();
        if (VolumeState.CurrentUserStatus == null)
        {
            return;
        }

        if (VolumeState.CurrentUserStatus.IsInWishlist)
        {
            availableActions.Add(new AvailableAction("RemoveFromWishlist", Icons.Material.Filled.RemoveShoppingCart, Color.Warning, () => ToggleWishList()));
        }
        else
        {
            availableActions.Add(new AvailableAction("AddToWishlist", CustomIcons.wishlist, Color.Success, () => ToggleWishList()));
        }

        if (Volume.IsPreorder && VolumeState.CurrentUserStatus.CurrentOwnershipStatus != VolumeStatus.Preorder)
        {
            availableActions.Add(new AvailableAction("SetPreorder", CustomIcons.preorder, Color.Info, () => OpenSetOwnershipDialog(VolumeStatus.Preorder)));
        }
        else
        {
            if (VolumeState.CurrentUserStatus.CurrentOwnershipStatus == VolumeStatus.Own)
            {
                availableActions.Add(new AvailableAction("SetGone", Icons.Material.Filled.RemoveCircle, Color.Error, () => OpenSetOwnershipDialog(VolumeStatus.Gone)));
            }
            else
            {
                availableActions.Add(new AvailableAction("SetOwn", CustomIcons.bookshelf, Color.Success, () => OpenSetOwnershipDialog(VolumeStatus.Own)));
            }
        }


    }

    private async Task ToggleWishList()
    {
        try
        {

            var (userStatus, stats) = await VolumeService.ToggleWishlist(Volume.PublicId, await GetUserId());
            VolumeState.UpdateBoth(userStatus, stats);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling wishlist for PublicId: {PublicId}", Volume.PublicId);
        }
    }

    private async Task ToggleLike(MouseEventArgs args)
    {
        try
        {
            var (userStatus, stats) = await VolumeService.ToggleLike(Volume.PublicId, await GetUserId());
            VolumeState.UpdateBoth(userStatus, stats);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling like for PublicId: {PublicId}", Volume.PublicId);
        }
    }



    @inject IDialogService Dialog

    private async Task OpenSetOwnershipDialog(VolumeStatus status)
    {
        var dialogOptions = new DialogOptions()
        {
            FullWidth = false,
            Position = DialogPosition.Center,
        };
        var parameters = new DialogParameters
        {
            {   nameof(SetOwnershipDialog.Ownership),
                new Ownership()
                {
                    Status = status,
                    Date = DateTime.Now,
                    Type = VolumeType.Physical
                }
            }
        };
        var dialog = await Dialog.ShowAsync<SetOwnershipDialog>(string.Empty, parameters, dialogOptions);

        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                var ownership = result.Data as Ownership;

                if (ownership is null)
                {
                    throw new InvalidOperationException("Ownership data is null");
                }

                var (userStatus, stats) = await VolumeService.AddOwnershipAsync(Volume.PublicId, await GetUserId(), ownership);
                VolumeState.UpdateBoth(userStatus, stats);
            }
            catch (Exception)
            {
                Logger.LogError("Error adding ownership for volume {PublicId}", Volume.PublicId);
            }

        }
    }

    private async Task ShowAddEditReadingDialog(Reading? reading = null)
    {
        var dialogOptions = new DialogOptions()
        {
            FullWidth = false,
            Position = DialogPosition.Center,
        };

        if (reading == null)
        {
            reading = new Reading()
            {
                Rating = 0,
                StartedAt = DateTime.UtcNow,
                Status = ReadingStatus.PlanToRead,
                VolumeId = Volume.Id,
                UserId = await GetUserIdGuid()
            };
        }

        var parameters = new DialogParameters
        {
            {
                nameof(AddEditReadingDialog.Reading),
                reading
            }
        };
        var dialog = await Dialog.ShowAsync<AddEditReadingDialog>(string.Empty, parameters, dialogOptions);

        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                var (userStatus, stats) = await VolumeService.AddEditReadingAsync(reading);
                VolumeState.UpdateBoth(userStatus, stats);
            }
            catch (Exception ex)
            {
                Logger.LogError("Error adding ownership for volume {PublicId}. Exception:{ex}", Volume.PublicId, ex.Message);
                Snackbar.Add(Localizer["ErrorAddingReading"], Severity.Error);
            }

        }
    }


    private async Task LoadVolumeUserStatus()
    {
        try
        {
            var userStatus = await VolumeService.GetVolumeStatusInfo(Volume.PublicId, await GetUserId());
            VolumeState.UpdateUserStatus(userStatus);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading volume user status for PublicId: {PublicId}", Volume.PublicId);
        }
    }

    [CascadingParameter]
    public required Task<AuthenticationState> AuthStateTask { get; set; }

    private async Task<string> GetUserId()
    {
        var authState = await AuthStateTask;
        var user = authState.User;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (userId == null)
        {
            throw new InvalidOperationException("User is not authenticated");
        }
        return userId;
    }

    private async Task<Guid> GetUserIdGuid()
    {
        return Guid.Parse(await GetUserId());
    }

    private async Task<bool> IsUserAuthenticated()
    {
        if (AuthStateTask == null)
            return false;

        var authState = await AuthStateTask;
        return authState.User?.Identity?.IsAuthenticated ?? false;
    }
}