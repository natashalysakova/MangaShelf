@using MangaShelf.Components.Pages
@using MangaShelf.DAL.Models
@using System.Security.Claims
@using System.Threading.Tasks

@inject IVolumePageLocalizationService Localizer
@inject IVolumeStateService VolumeState

@implements IDisposable

@if (ReviewsList != null)
{
    <MudText Typo="Typo.h5" Class="mb-4">@Localizer["Reviews"]</MudText>
    if (ReviewsList.Any())
    {

        <MudStack>
            @foreach (var review in ReviewsList)
            {
                <ReviewComponent Review="@review" />
            }
        </MudStack>
    }
    else
    {
        <MudText>@Localizer["NoReviews"]</MudText>

    }
}
else if (ReviewsList == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}

@code {

    [Parameter]
    [EditorRequired]
    public required Guid VolumeId { get; set; }

    [Inject]
    public required IVolumeService VolumeService { get; set; }

    private IEnumerable<ReviewDto>? ReviewsList { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        VolumeState.OnUserStatusChanged += HandleReviewsUpdated;
    }

    override protected async Task OnParametersSetAsync()
    {
        await LoadReviews();
        StateHasChanged();
    }

    public void Dispose()
    {
        VolumeState.OnUserStatusChanged -= HandleReviewsUpdated;
    }

    private void HandleReviewsUpdated()
    {
        InvokeAsync(async () =>
        {
            await LoadReviews();
            StateHasChanged();
        });
    }

    private async Task LoadReviews()
    {
        try
        {
            ReviewsList = await VolumeService.GetReviews(VolumeId);
        }
        catch (Exception)
        {
        }
    }
}